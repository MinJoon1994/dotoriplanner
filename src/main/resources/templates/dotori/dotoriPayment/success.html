<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultrag.net.nz/.thymeleaf/layout"
      layout:decorate="~{layouts/base}">
<head>
  <meta charset="utf-8" />
</head>
<body>
  <div layout:fragment="content">
    <!-- ê²°ì œ ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ -->
    <h2>ê²°ì œ ì„±ê³µ</h2>

    <!-- ê²°ì œ ê´€ë ¨ ì •ë³´ ì¶œë ¥ ì˜ì—­ -->
    <p id="paymentKey"></p>
    <p id="orderId"></p>
    <p id="amount"></p>

    <script>
      // ğŸŒŸ [1] URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ ê²°ì œ ê´€ë ¨ ì •ë³´ ì¶”ì¶œ
      // ì˜ˆ: /success?paymentKey=abc&orderId=123&amount=10000
      const urlParams = new URLSearchParams(window.location.search);
      const paymentKey = urlParams.get("paymentKey");
      const orderId = urlParams.get("orderId");
      const amount = urlParams.get("amount");

      // ğŸŒŸ [2] ê²°ì œ ìŠ¹ì¸ ìš”ì²­ í•¨ìˆ˜
      async function confirm() {
        // ê²°ì œ ìŠ¹ì¸ APIì— ë³´ë‚¼ ìš”ì²­ ë°ì´í„° êµ¬ì„±
        const requestData = {
          paymentKey: paymentKey,
          orderId: orderId,
          amount: amount,
        };

        // ğŸŒŸ [2-1] ë°±ì—”ë“œë¡œ ê²°ì œ ìŠ¹ì¸ ìš”ì²­ ì „ì†¡
        const response = await fetch("/dotoriPayment/confirm", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(requestData), // JSON í˜•íƒœë¡œ ìš”ì²­
        });

        // ì‘ë‹µì„ JSON ìœ¼ë¡œ íŒŒì‹±
        const json = await response.json();

        // ğŸŒŸ [2-2] ì‹¤íŒ¨ ì‘ë‹µì¸ ê²½ìš° ì‹¤íŒ¨ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜
        if (!response.ok) {
          console.log(json); // ì—ëŸ¬ ë©”ì‹œì§€ ë¡œê·¸ ì¶œë ¥
          window.location.href = `/fail?message=${encodeURIComponent(json.message)}&code=${json.code}`;
        }

        // ğŸŒŸ [2-3] ì„±ê³µ ì‘ë‹µì¸ ê²½ìš° ì²˜ë¦¬ (í˜„ì¬ëŠ” ì½˜ì†” ì¶œë ¥)
        console.log(json);
      }

      // í˜ì´ì§€ ë¡œë”© ì‹œ ê²°ì œ ìŠ¹ì¸ ìš”ì²­ ì‹¤í–‰
      confirm();

      // ğŸŒŸ [3] ê²°ì œ ì„±ê³µ ì •ë³´ í™”ë©´ì— í‘œì‹œ
      const paymentKeyElement = document.getElementById("paymentKey");
      const orderIdElement = document.getElementById("orderId");
      const amountElement = document.getElementById("amount");

      // ê²°ì œ ì •ë³´ í…ìŠ¤íŠ¸ ì„¤ì •
      orderIdElement.textContent = "ì£¼ë¬¸ë²ˆí˜¸: " + orderId;
      amountElement.textContent = "ê²°ì œ ê¸ˆì•¡: " + amount;
      paymentKeyElement.textContent = "paymentKey: " + paymentKey;
    </script>
  </div>


</body>
</html>
